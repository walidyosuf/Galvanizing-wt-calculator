<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>????? ??????? ?????? ????????? ????????</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Cairo for Arabic UI -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- SheetJS for Excel file reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Cairo', 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        .lang-btn.active {
            background-color: #2563eb;
            color: white;
        }
        .drop-area {
            border: 2px dashed #3b82f6;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            background: rgba(59, 130, 246, 0.05);
        }
        .drop-area.active {
            background: rgba(59, 130, 246, 0.15);
            border-color: #1d4ed8;
        }
        .result-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .file-table {
            max-height: 400px;
            overflow-y: auto;
        }
        .table-row:nth-child(even) {
            background-color: #f9fafb;
        }
        .table-row:hover {
            background-color: #f0f5ff;
        }
        .zinc-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .progress-bar {
            height: 8px;
            border-radius: 4px;
            background: #e5e7eb;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #60a5fa, #3b82f6);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .pulse {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Language Switcher -->
        <div class="flex justify-end mb-4">
            <button id="lang-ar" class="lang-btn px-4 py-2 rounded-r-lg border border-gray-300 active">???????</button>
            <button id="lang-en" class="lang-btn px-4 py-2 rounded-l-lg border border-gray-300">English</button>
        </div>
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-blue-600">????? ??????? ?????? ????????? ????????</h1>
            <p class="text-md sm:text-lg text-gray-600 mt-2">???? ????? ??? ????????? ???????? ?????? ?????? ??????? ??? ???????? ISO 1461</p>
        </header>
        <!-- Excel File Upload Section -->
        <section class="bg-white p-6 rounded-2xl shadow-lg mb-8">
            <h2 class="text-2xl font-bold mb-4 text-center">????? ??? ??????</h2>
            <div id="dropArea" class="drop-area mb-6">
                <div class="mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                </div>
                <p class="text-gray-700 mb-4">???? ??? ?????? ??? ?? ???? ??????? ???</p>
                <input type="file" id="excelFile" accept=".xlsx, .xls" class="hidden">
                <button id="selectFileBtn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">???? ???</button>
                <p class="text-gray-500 text-sm mt-4">??? ?? ????? ????? ??? ?????: Pmark, Profile, Length, Pweight, Qty, Tweight</p>
            </div>
            <div id="fileInfo" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="font-bold text-lg text-blue-800" id="fileName">???.xlsx</h3>
                        <p class="text-blue-600" id="fileDetails">30 ??? 5 ?????</p>
                    </div>
                    <button id="clearFileBtn" class="text-red-500 hover:text-red-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="progress-bar mt-3">
                    <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                </div>
            </div>
            <div class="text-center">
                <button id="calculateExcelBtn" class="bg-green-600 text-white text-xl font-bold py-3 px-8 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 transition-transform transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    ???? ??????? ?????
                </button>
            </div>
        </section>
        <!-- Excel Results Section -->
        <section id="excelResults" class="bg-white p-6 rounded-2xl shadow-lg mb-8 hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">????? ???? ???????</h2>
                <button id="exportResultsBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    ????? ???????
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="result-card bg-blue-50 p-4 rounded-lg text-center">
                    <span class="block text-sm font-semibold text-blue-700">?????? ??? ?????????</span>
                    <p id="totalSteelWeight" class="text-2xl font-bold text-blue-600">0.00 ???</p>
                </div>
                <div class="result-card bg-green-50 p-4 rounded-lg text-center">
                    <span class="block text-sm font-semibold text-green-700">??????? ??????? ?????????</span>
                    <p id="totalSurfaceArea" class="text-2xl font-bold text-green-600">0.00 ?²</p>
                </div>
                <div class="result-card bg-yellow-50 p-4 rounded-lg text-center">
                    <span class="block text-sm font-semibold text-yellow-700">??? ????? ???????</span>
                    <p id="totalZincWeight" class="text-2xl font-bold text-yellow-600">0.00 ??</p>
                </div>
                <div class="result-card bg-purple-50 p-4 rounded-lg text-center">
                    <span class="block text-sm font-semibold text-purple-700">??? ?????????</span>
                    <p id="totalItems" class="text-2xl font-bold text-purple-600">0</p>
                </div>
            </div>
            <div class="file-table">
                <table class="min-w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="py-3 px-4 text-right font-semibold text-gray-700">??????</th>
                            <th class="py-3 px-4 text-right font-semibold text-gray-700">?????</th>
                            <th class="py-3 px-4 text-right font-semibold text-gray-700">????? (??)</th>
                            <th class="py-3 px-4 text-right font-semibold text-gray-700">??????</th>
                            <th class="py-3 px-4 text-right font-semibold text-gray-700">????? (???)</th>
                            <th class="py-3 px-4 text-right font-semibold text-gray-700">??????? (?²)</th>
                            <th class="py-3 px-4 text-right font-semibold text-gray-700">????? (??)</th>
                        </tr>
                    </thead>
                    <tbody id="excelTableBody"></tbody>
                </table>
            </div>
        </section>
        <!-- Original Calculator -->
        <main class="bg-white p-6 rounded-2xl shadow-lg">
            <h2 class="text-2xl font-bold mb-6 text-center">????? ?????</h2>
            <!-- Section Selection -->
            <div class="mb-6">
                <label for="sectionType" class="block mb-2 text-lg font-semibold text-gray-700">???? ??? ??????:</label>
                <select id="sectionType" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    <option value="plate">????? (???)</option>
                    <option value="angle">?????</option>
                    <option value="iBeam">??? (I-Beam)</option>
                    <option value="uChannel">??? ???? (U-Channel)</option>
                    <option value="roundBar">????? (???)</option>
                    <option value="pipe">??????</option>
                </select>
            </div>
            <!-- Dynamic Input Fields Container -->
            <div id="inputsContainer">
                <!-- Plate Inputs -->
                <div id="plateInputs" class="space-y-4">
                    <h3 class="text-xl font-semibold border-b border-gray-200 pb-2 mb-4">????? ??????? (??)</h3>
                    <div>
                        <label for="plateLength" class="block mb-1 font-medium">????? (L)</label>
                        <input type="number" id="plateLength" placeholder="????: 1000" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="plateWidth" class="block mb-1 font-medium">????? (W)</label>
                        <input type="number" id="plateWidth" placeholder="????: 200" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="plateThickness" class="block mb-1 font-medium">?????? (T)</label>
                        <input type="number" id="plateThickness" placeholder="????: 10" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <!-- Angle Inputs -->
                <div id="angleInputs" class="hidden space-y-4">
                    <h3 class="text-xl font-semibold border-b border-gray-200 pb-2 mb-4">????? ???????</h3>
                    <div>
                        <label for="angleSize" class="block mb-1 font-medium">???? ???? ??????? (??)</label>
                        <select id="angleSize" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></select>
                    </div>
                    <div>
                        <label for="angleLength" class="block mb-1 font-medium">????? (??)</label>
                        <input type="number" id="angleLength" placeholder="????: 6000" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <!-- I-Beam Inputs -->
                <div id="iBeamInputs" class="hidden space-y-4">
                    <h3 class="text-xl font-semibold border-b border-gray-200 pb-2 mb-4">????? ?????</h3>
                    <div>
                        <label for="iBeamSize" class="block mb-1 font-medium">???? ???? ????? (IPE)</label>
                        <select id="iBeamSize" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></select>
                    </div>
                    <div>
                        <label for="iBeamLength" class="block mb-1 font-medium">????? (??)</label>
                        <input type="number" id="iBeamLength" placeholder="????: 6000" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <!-- U-Channel Inputs -->
                <div id="uChannelInputs" class="hidden space-y-4">
                    <h3 class="text-xl font-semibold border-b border-gray-200 pb-2 mb-4">????? ??? ??????</h3>
                    <div>
                        <label for="uChannelSize" class="block mb-1 font-medium">???? ???? ??? ?????? (UPN)</label>
                        <select id="uChannelSize" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></select>
                    </div>
                    <div>
                        <label for="uChannelLength" class="block mb-1 font-medium">????? (??)</label>
                        <input type="number" id="uChannelLength" placeholder="????: 6000" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <!-- Round Bar Inputs -->
                <div id="roundBarInputs" class="hidden space-y-4">
                    <h3 class="text-xl font-semibold border-b border-gray-200 pb-2 mb-4">????? ??????? (??)</h3>
                    <div>
                        <label for="barDiameter" class="block mb-1 font-medium">????? (D)</label>
                        <input type="number" id="barDiameter" placeholder="????: 20" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="barLength" class="block mb-1 font-medium">????? (L)</label>
                        <input type="number" id="barLength" placeholder="????: 1000" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <!-- Pipe Inputs -->
                <div id="pipeInputs" class="hidden space-y-4">
                    <h3 class="text-xl font-semibold border-b border-gray-200 pb-2 mb-4">????? ???????? (??)</h3>
                    <div>
                        <label for="pipeOuterDiameter" class="block mb-1 font-medium">????? ??????? (OD)</label>
                        <input type="number" id="pipeOuterDiameter" placeholder="????: 114" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="pipeThickness" class="block mb-1 font-medium">?????? (T)</label>
                        <input type="number" id="pipeThickness" placeholder="????: 4" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="pipeLength" class="block mb-1 font-medium">????? (L)</label>
                        <input type="number" id="pipeLength" placeholder="????: 1000" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
            </div>
            <!-- Calculate Button -->
            <div class="mt-8">
                <button id="calculateBtn" class="w-full bg-blue-600 text-white text-xl font-bold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-transform transform hover:scale-105">????</button>
            </div>
        </main>
        <!-- Results Section -->
        <div id="results" class="mt-8 bg-white p-6 rounded-2xl shadow-lg hidden">
            <h2 class="text-2xl font-bold text-center mb-6 border-b-2 border-blue-500 pb-3">???????</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 text-lg">
                <div class="result-card bg-blue-50 p-4 rounded-lg text-center">
                    <span class="block text-sm font-semibold text-blue-700">??? ????????</span>
                    <p id="steelWeightResult" class="text-2xl font-bold text-blue-600"></p>
                </div>
                <div class="result-card bg-green-50 p-4 rounded-lg text-center">
                    <span class="block text-sm font-semibold text-green-700">??????? ???????</span>
                    <p id="surfaceAreaResult" class="text-2xl font-bold text-green-600"></p>
                </div>
                <div class="result-card bg-yellow-50 p-4 rounded-lg text-center">
                    <span class="block text-sm font-semibold text-yellow-700">??? ????? ???????</span>
                    <p id="zincWeightResult" class="text-2xl font-bold text-yellow-600"></p>
                </div>
                <div class="result-card bg-purple-50 p-4 rounded-lg text-center">
                    <span class="block text-sm font-semibold text-purple-700">???? ????? ?????</span>
                    <p id="zincRatioResult" class="text-2xl font-bold text-purple-600"></p>
                </div>
                <div class="result-card bg-indigo-50 p-4 rounded-lg text-center col-span-1 md:col-span-2 lg:col-span-1">
                    <span class="block text-sm font-semibold text-indigo-700">????? ?????? (ISO 1461)</span>
                    <p id="coatingThicknessResult" class="text-2xl font-bold text-indigo-600"></p>
                </div>
            </div>
             <div id="error-message" class="mt-4 text-center text-red-500 font-semibold"></div>
        </div>
        <footer class="text-center mt-8 text-sm text-gray-500">
            <p>????? ?????? ????????? ?? ??????: 7.85 ??/??³.</p>
            <p>?????? ????? ??? ????? ???????? ???????? ???????? ISO 1461.</p>
        </footer>
    </div>
    <script>
        // --- TRANSLATIONS ---
        const translations = {
            en: {
                appTitle: "Galvanizing & Weight Calculator",
                appSubtitle: "Tool to calculate steel weight and required zinc for galvanizing per ISO 1461",
                selectSection: "Select Section Type:",
                plate: "Plate",
                angle: "Angle",
                iBeam: "I-Beam",
                uChannel: "U-Channel (UPN)",
                roundBar: "Round Bar",
                pipe: "Pipe",
                plateDimensions: "Plate Dimensions (mm)",
                lengthL: "Length (L)",
                widthW: "Width (W)",
                thicknessT: "Thickness (T)",
                angleDimensions: "Angle Dimensions",
                selectAngleSize: "Select Angle Size (mm)",
                length_mm: "Length (mm)",
                iBeamDimensions: "I-Beam Dimensions",
                selectIBeamSize: "Select I-Beam Size (IPE)",
                uChannelDimensions: "U-Channel Dimensions",
                selectUChannelSize: "Select U-Channel Size (UPN)",
                roundBarDimensions: "Round Bar Dimensions (mm)",
                diameterD: "Diameter (D)",
                pipeDimensions: "Pipe Dimensions (mm)",
                outerDiameterOD: "Outer Diameter (OD)",
                calculate: "Calculate",
                resultsTitle: "Results",
                steelWeight: "Steel Weight",
                surfaceArea: "Surface Area",
                zincWeight: "Expected Zinc Weight",
                zincRatio: "Zinc to Weight Ratio",
                coatingThickness: "Coating Thickness (ISO 1461)",
                footerDensity: "Steel density used: 7.85 g/cm³.",
                footerISO: "Zinc calculations are based on ISO 1461 standard.",
                errorInvalid: (field) => `Invalid value in field '${field}'. Please enter a positive number.`,
                errorPipeThickness: "Pipe thickness must be less than half its outer diameter.",
                example_1000: "e.g., 1000",
                example_200: "e.g., 200",
                example_10: "e.g., 10",
                example_6000: "e.g., 6000",
                example_20: "e.g., 20",
                example_114: "e.g., 114",
                example_4: "e.g., 4"
            },
            ar: {
                appTitle: "????? ??????? ??????",
                appSubtitle: "???? ????? ??? ????????? ???????? ?????? ?????? ??????? ??? ???????? ISO 1461",
                selectSection: "???? ??? ??????:",
                plate: "????? (???)",
                angle: "?????",
                iBeam: "??? (I-Beam)",
                uChannel: "??? ???? (U-Channel)",
                roundBar: "????? (???)",
                pipe: "??????",
                plateDimensions: "????? ??????? (??)",
                lengthL: "????? (L)",
                widthW: "????? (W)",
                thicknessT: "?????? (T)",
                angleDimensions: "????? ???????",
                selectAngleSize: "???? ???? ??????? (??)",
                length_mm: "????? (??)",
                iBeamDimensions: "????? ?????",
                selectIBeamSize: "???? ???? ????? (IPE)",
                uChannelDimensions: "????? ??? ??????",
                selectUChannelSize: "???? ???? ??? ?????? (UPN)",
                roundBarDimensions: "????? ??????? (??)",
                diameterD: "????? (D)",
                pipeDimensions: "????? ???????? (??)",
                outerDiameterOD: "????? ??????? (OD)",
                calculate: "????",
                resultsTitle: "???????",
                steelWeight: "??? ????????",
                surfaceArea: "??????? ???????",
                zincWeight: "??? ????? ???????",
                zincRatio: "???? ????? ?????",
                coatingThickness: "????? ?????? (ISO 1461)",
                footerDensity: "????? ?????? ????????? ?? ??????: 7.85 ??/??³.",
                footerISO: "?????? ????? ??? ????? ???????? ???????? ???????? ISO 1461.",
                errorInvalid: (field) => `???? ??? ????? ?? ????? '${field}'. ???? ????? ??? ????.`,
                errorPipeThickness: "??? ???????? ??? ?? ???? ??? ?? ??? ????? ???????.",
                example_1000: "????: 1000",
                example_200: "????: 200",
                example_10: "????: 10",
                example_6000: "????: 6000",
                example_20: "????: 20",
                example_114: "????: 114",
                example_4: "????: 4"
            }
        };
        // --- DATA & CONSTANTS ---
        const STEEL_DENSITY = 0.00785; // g/mm^3
        const ANGLE_DATA = {
            "25x25x3": { weight_kg_per_m: 1.12, area_m2_per_m: 0.098, thickness_mm: 3 },
            "30x30x3": { weight_kg_per_m: 1.36, area_m2_per_m: 0.118, thickness_mm: 3 },
            "40x40x4": { weight_kg_per_m: 2.42, area_m2_per_m: 0.157, thickness_mm: 4 },
            "50x50x5": { weight_kg_per_m: 3.77, area_m2_per_m: 0.196, thickness_mm: 5 },
            "60x60x6": { weight_kg_per_m: 5.42, area_m2_per_m: 0.235, thickness_mm: 6 },
            "75x75x6": { weight_kg_per_m: 6.85, area_m2_per_m: 0.295, thickness_mm: 6 },
            "75x75x8": { weight_kg_per_m: 8.99, area_m2_per_m: 0.294, thickness_mm: 8 },
            "80x80x8": { weight_kg_per_m: 9.63, area_m2_per_m: 0.313, thickness_mm: 8 },
            "90x90x8": { weight_kg_per_m: 10.9, area_m2_per_m: 0.353, thickness_mm: 8 },
            "100x100x8": { weight_kg_per_m: 12.2, area_m2_per_m: 0.392, thickness_mm: 8 },
            "100x100x10": { weight_kg_per_m: 15.0, area_m2_per_m: 0.391, thickness_mm: 10 },
            "120x120x10": { weight_kg_per_m: 18.2, area_m2_per_m: 0.470, thickness_mm: 10 },
            "120x120x12": { weight_kg_per_m: 21.6, area_m2_per_m: 0.469, thickness_mm: 12 },
            "150x150x12": { weight_kg_per_m: 27.3, area_m2_per_m: 0.588, thickness_mm: 12 },
            "150x150x15": { weight_kg_per_m: 33.8, area_m2_per_m: 0.586, thickness_mm: 15 },
            "200x200x16": { weight_kg_per_m: 48.5, area_m2_per_m: 0.784, thickness_mm: 16 },
            "200x200x20": { weight_kg_per_m: 59.9, area_m2_per_m: 0.781, thickness_mm: 20 },
        };
        const I_BEAM_DATA = {
            "IPE 80":  { weight_kg_per_m: 6.0, area_m2_per_m: 0.26, thickness_mm: 5.9 },
            "IPE 100": { weight_kg_per_m: 8.1, area_m2_per_m: 0.33, thickness_mm: 5.7 },
            "IPE 120": { weight_kg_per_m: 10.4, area_m2_per_m: 0.40, thickness_mm: 6.3 },
            "IPE 140": { weight_kg_per_m: 12.9, area_m2_per_m: 0.48, thickness_mm: 6.9 },
            "IPE 160": { weight_kg_per_m: 15.8, area_m2_per_m: 0.55, thickness_mm: 7.4 },
            "IPE 180": { weight_kg_per_m: 18.8, area_m2_per_m: 0.63, thickness_mm: 8.0 },
            "IPE 200": { weight_kg_per_m: 22.4, area_m2_per_m: 0.71, thickness_mm: 8.5 },
            "IPE 220": { weight_kg_per_m: 26.2, area_m2_per_m: 0.78, thickness_mm: 9.2 },
            "IPE 240": { weight_kg_per_m: 30.7, area_m2_per_m: 0.87, thickness_mm: 9.8 },
            "IPE 270": { weight_kg_per_m: 36.1, area_m2_per_m: 0.97, thickness_mm: 10.2 },
            "IPE 300": { weight_kg_per_m: 42.2, area_m2_per_m: 1.06, thickness_mm: 10.7 },
        };
        const U_CHANNEL_DATA = {
            "UPN 80":  { weight_kg_per_m: 8.64, area_m2_per_m: 0.25, thickness_mm: 6 },
            "UPN 100": { weight_kg_per_m: 10.6, area_m2_per_m: 0.30, thickness_mm: 6 },
            "UPN 120": { weight_kg_per_m: 13.4, area_m2_per_m: 0.35, thickness_mm: 7 },
            "UPN 140": { weight_kg_per_m: 16.0, area_m2_per_m: 0.40, thickness_mm: 7 },
            "UPN 160": { weight_kg_per_m: 18.8, area_m2_per_m: 0.45, thickness_mm: 7.5 },
            "UPN 180": { weight_kg_per_m: 22.0, area_m2_per_m: 0.50, thickness_mm: 8 },
            "UPN 200": { weight_kg_per_m: 25.3, area_m2_per_m: 0.55, thickness_mm: 8.5 },
            "UPN 220": { weight_kg_per_m: 29.4, area_m2_per_m: 0.60, thickness_mm: 9 },
            "UPN 240": { weight_kg_per_m: 33.2, area_m2_per_m: 0.65, thickness_mm: 9.5 },
            "UPN 260": { weight_kg_per_m: 37.9, area_m2_per_m: 0.70, thickness_mm: 10 },
            "UPN 280": { weight_kg_per_m: 41.8, area_m2_per_m: 0.75, thickness_mm: 10 },
            "UPN 300": { weight_kg_per_m: 46.2, area_m2_per_m: 0.80, thickness_mm: 10 },
        };
        // --- DOM ELEMENTS ---
        const sectionTypeSelect = document.getElementById('sectionType');
        const calculateBtn = document.getElementById('calculateBtn');
        const resultsDiv = document.getElementById('results');
        const errorMessageDiv = document.getElementById('error-message');
        const inputGroups = {
            plate: document.getElementById('plateInputs'),
            angle: document.getElementById('angleInputs'),
            iBeam: document.getElementById('iBeamInputs'),
            uChannel: document.getElementById('uChannelInputs'),
            roundBar: document.getElementById('roundBarInputs'),
            pipe: document.getElementById('pipeInputs'),
        };
        const resultFields = {
            steelWeight: document.getElementById('steelWeightResult'),
            surfaceArea: document.getElementById('surfaceAreaResult'),
            zincWeight: document.getElementById('zincWeightResult'),
            zincRatio: document.getElementById('zincRatioResult'),
            coatingThickness: document.getElementById('coatingThicknessResult')
        };
        // Excel elements
        const excelFileInput = document.getElementById('excelFile');
        const selectFileBtn = document.getElementById('selectFileBtn');
        const dropArea = document.getElementById('dropArea');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileDetails = document.getElementById('fileDetails');
        const clearFileBtn = document.getElementById('clearFileBtn');
        const calculateExcelBtn = document.getElementById('calculateExcelBtn');
        const excelResults = document.getElementById('excelResults');
        const excelTableBody = document.getElementById('excelTableBody');
        const totalSteelWeight = document.getElementById('totalSteelWeight');
        const totalSurfaceArea = document.getElementById('totalSurfaceArea');
        const totalZincWeight = document.getElementById('totalZincWeight');
        const totalItems = document.getElementById('totalItems');
        const exportResultsBtn = document.getElementById('exportResultsBtn');
        const progressFill = document.getElementById('progressFill');
        let currentLang = 'ar';
        let excelData = [];
        // --- FUNCTIONS ---
        function switchLanguage(lang) {
            currentLang = lang;
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            document.querySelectorAll('[data-lang]').forEach(el => {
                const key = el.getAttribute('data-lang');
                if (translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });
            document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
                const key = el.getAttribute('data-lang-placeholder');
                if (translations[lang][key]) {
                    el.placeholder = translations[lang][key];
                }
            });
            // Update selectors
            populateAngleSelector();
            populateIBeamSelector();
            populateUChannelSelector();
            // Update button styles
            document.getElementById('lang-ar').classList.toggle('active', lang === 'ar');
            document.getElementById('lang-en').classList.toggle('active', lang === 'en');
        }
        function populateAngleSelector() {
            const angleSizeSelect = document.getElementById('angleSize');
            const savedValue = angleSizeSelect.value;
            angleSizeSelect.innerHTML = ''; // Clear existing options
            const prefix = currentLang === 'ar' ? '?????' : 'Angle';
            Object.keys(ANGLE_DATA).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = `${prefix} ${key}`;
                angleSizeSelect.appendChild(option);
            });
            angleSizeSelect.value = savedValue;
        }
        function populateIBeamSelector() {
            const iBeamSizeSelect = document.getElementById('iBeamSize');
            const savedValue = iBeamSizeSelect.value;
            iBeamSizeSelect.innerHTML = ''; // Clear existing options
            Object.keys(I_BEAM_DATA).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = key;
                iBeamSizeSelect.appendChild(option);
            });
            iBeamSizeSelect.value = savedValue;
        }
        function populateUChannelSelector() {
            const uChannelSizeSelect = document.getElementById('uChannelSize');
            const savedValue = uChannelSizeSelect.value;
            uChannelSizeSelect.innerHTML = ''; // Clear existing options
            Object.keys(U_CHANNEL_DATA).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = key;
                uChannelSizeSelect.appendChild(option);
            });
            uChannelSizeSelect.value = savedValue;
        }
        function updateVisibleInputs() {
            const selectedType = sectionTypeSelect.value;
            Object.values(inputGroups).forEach(group => group.classList.add('hidden'));
            if (inputGroups[selectedType]) {
                inputGroups[selectedType].classList.remove('hidden');
            }
        }
        function getZincCoatingInfo(thickness_mm) {
            if (thickness_mm > 6) return { weight_g_m2: 610, thickness_um: 85 };
            if (thickness_mm > 3) return { weight_g_m2: 460, thickness_um: 65 };
            if (thickness_mm > 1.5) return { weight_g_m2: 325, thickness_um: 45 };
            if (thickness_mm <= 1.5) return { weight_g_m2: 250, thickness_um: 35 };
            return { weight_g_m2: 0, thickness_um: 0 };
        }
        function performCalculations() {
            const type = sectionTypeSelect.value;
            let surfaceArea_mm2 = 0, volume_mm3 = 0, steelWeight_g = 0, partThickness_mm = 0;
            errorMessageDiv.textContent = '';
            try {
                const getVal = (id) => {
                    const el = document.getElementById(id);
                    const labelEl = document.querySelector(`label[for=${id}]`);
                    const val = parseFloat(el.value);
                    if (isNaN(val) || val <= 0) {
                        const fieldName = labelEl.textContent;
                        throw new Error(translations[currentLang].errorInvalid(fieldName));
                    }
                    return val;
                };
                switch (type) {
                    case 'plate':
                        const l = getVal('plateLength'), w = getVal('plateWidth'), t = getVal('plateThickness');
                        partThickness_mm = t;
                        surfaceArea_mm2 = 2 * (l * w + l * t + w * t);
                        volume_mm3 = l * w * t;
                        break;
                    case 'angle':
                        const angleKey = document.getElementById('angleSize').value;
                        const angleData = ANGLE_DATA[angleKey];
                        const angleL = getVal('angleLength');
                        partThickness_mm = angleData.thickness_mm;
                        const length_m_angle = angleL / 1000;
                        steelWeight_g = angleData.weight_kg_per_m * length_m_angle * 1000;
                        surfaceArea_mm2 = angleData.area_m2_per_m * length_m_angle * 1000000;
                        break;
                    case 'iBeam':
                        const iBeamKey = document.getElementById('iBeamSize').value;
                        const iBeamData = I_BEAM_DATA[iBeamKey];
                        const iBeamL = getVal('iBeamLength');
                        partThickness_mm = iBeamData.thickness_mm;
                        const length_m_ibeam = iBeamL / 1000;
                        steelWeight_g = iBeamData.weight_kg_per_m * length_m_ibeam * 1000;
                        surfaceArea_mm2 = iBeamData.area_m2_per_m * length_m_ibeam * 1000000;
                        break;
                    case 'uChannel':
                        const uChannelKey = document.getElementById('uChannelSize').value;
                        const uChannelData = U_CHANNEL_DATA[uChannelKey];
                        const uChannelL = getVal('uChannelLength');
                        partThickness_mm = uChannelData.thickness_mm; // Use web thickness
                        const length_m_uchannel = uChannelL / 1000;
                        steelWeight_g = uChannelData.weight_kg_per_m * length_m_uchannel * 1000;
                        surfaceArea_mm2 = uChannelData.area_m2_per_m * length_m_uchannel * 1000000;
                        break;
                    case 'roundBar':
                        const d = getVal('barDiameter'), barL = getVal('barLength');
                        const r = d / 2;
                        partThickness_mm = d;
                        surfaceArea_mm2 = (2 * Math.PI * r * r) + (2 * Math.PI * r * barL);
                        volume_mm3 = Math.PI * r * r * barL;
                        break;
                    case 'pipe':
                        const od = getVal('pipeOuterDiameter'), pipeT = getVal('pipeThickness'), pipeL = getVal('pipeLength');
                        if (pipeT >= od / 2) throw new Error(translations[currentLang].errorPipeThickness);
                        const or = od / 2, ir = or - pipeT;
                        partThickness_mm = pipeT;
                        surfaceArea_mm2 = (2 * Math.PI * or * pipeL) + (2 * Math.PI * ir * pipeL) + (2 * (Math.PI * or * or - Math.PI * ir * ir));
                        volume_mm3 = (Math.PI * or * or - Math.PI * ir * ir) * pipeL;
                        break;
                }
                if (!['angle', 'iBeam', 'uChannel'].includes(type)) {
                    steelWeight_g = volume_mm3 * STEEL_DENSITY;
                }
                const steelWeight_kg = steelWeight_g / 1000;
                const surfaceArea_m2 = surfaceArea_mm2 / 1000000;
                const zincInfo = getZincCoatingInfo(partThickness_mm);
                const totalZinc_g = surfaceArea_m2 * zincInfo.weight_g_m2;
                const zincRatio = (steelWeight_g > 0) ? (totalZinc_g / steelWeight_g) * 100 : 0;
                displayResults({
                    steelWeight: steelWeight_kg,
                    surfaceArea: surfaceArea_m2,
                    zincWeight: totalZinc_g,
                    zincRatio: zincRatio,
                    coatingThickness: zincInfo.thickness_um
                });
            } catch (error) {
                errorMessageDiv.textContent = error.message;
                resultsDiv.classList.add('hidden');
            }
        }
        function displayResults(data) {
            resultFields.steelWeight.textContent = `${data.steelWeight.toFixed(2)} kg`;
            resultFields.surfaceArea.textContent = `${data.surfaceArea.toFixed(3)} m²`;
            resultFields.zincWeight.textContent = `${data.zincWeight.toFixed(2)} g`;
            resultFields.zincRatio.textContent = `${data.zincRatio.toFixed(2)} %`;
            resultFields.coatingThickness.textContent = `~ ${data.coatingThickness} µm`;
            resultsDiv.classList.remove('hidden');
            errorMessageDiv.textContent = '';
        }
        // Excel File Handling Functions
        function parseProfile(profile) {
            if (!profile) return null;
            
            // Plate profile (e.g., PL8*390)
            if (profile.startsWith('PL') && profile.includes('*')) {
                const parts = profile.substring(2).split('*');
                if (parts.length === 2) {
                    return {
                        type: 'plate',
                        thickness: parseFloat(parts[0]),
                        width: parseFloat(parts[1])
                    };
                }
            }
            // Angle profile (e.g., L80*8)
            else if (profile.startsWith('L') && profile.includes('*')) {
                const parts = profile.substring(1).split('*');
                if (parts.length === 2) {
                    return {
                        type: 'angle',
                        size: parseFloat(parts[0]),
                        thickness: parseFloat(parts[1])
                    };
                }
            }
            // I-Beam profile (e.g., IPE 100)
            else if (profile.startsWith('IPE ') || profile.startsWith('IPE')) {
                const size = profile.replace('IPE', '').trim();
                if (!isNaN(size) && size !== '') {
                    return {
                        type: 'iBeam',
                        size: size
                    };
                }
            }
            // U-Channel profile (e.g., UPN 100)
            else if (profile.startsWith('UPN ') || profile.startsWith('UPN')) {
                const size = profile.replace('UPN', '').trim();
                if (!isNaN(size) && size !== '') {
                    return {
                        type: 'uChannel',
                        size: size
                    };
                }
            }
            // Pipe profile (e.g., Ø114*4)
            else if (profile.startsWith('Ø') && profile.includes('*')) {
                const parts = profile.substring(1).split('*');
                if (parts.length === 2) {
                    return {
                        type: 'pipe',
                        outerDiameter: parseFloat(parts[0]),
                        thickness: parseFloat(parts[1])
                    };
                }
            }
            return null;
        }
        
        function calculateSurfaceArea(profileData, length) {
            if (!profileData || !length) return 0;
            
            switch (profileData.type) {
                case 'plate':
                    // Surface area = 2*(length*width + length*thickness + width*thickness)
                    return 2 * (length * profileData.width + 
                                length * profileData.thickness + 
                                profileData.width * profileData.thickness);
                case 'angle':
                    // Approximate surface area for angle: perimeter * length
                    const perimeter = 2 * (profileData.size + profileData.size) - 4 * profileData.thickness;
                    return perimeter * length;
                case 'iBeam':
                    // Get data from I_BEAM_DATA
                    const iBeamKey = `IPE ${profileData.size}`;
                    const iBeamData = I_BEAM_DATA[iBeamKey];
                    if (iBeamData) {
                        return iBeamData.area_m2_per_m * length * 1000; // Convert to mm²
                    }
                    return 0;
                case 'uChannel':
                    // Get data from U_CHANNEL_DATA
                    const uChannelKey = `UPN ${profileData.size}`;
                    const uChannelData = U_CHANNEL_DATA[uChannelKey];
                    if (uChannelData) {
                        return uChannelData.area_m2_per_m * length * 1000; // Convert to mm²
                    }
                    return 0;
                case 'pipe':
                    // Calculate surface area for pipe
                    const or = profileData.outerDiameter / 2;
                    const ir = or - profileData.thickness;
                    // External surface + Internal surface + 2 * (end area)
                    return (2 * Math.PI * or * length) + 
                           (2 * Math.PI * ir * length) + 
                           (2 * (Math.PI * or * or - Math.PI * ir * ir));
                default:
                    return 0;
            }
        }
        
        function processExcelFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    // Get the first worksheet
                    const worksheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[worksheetName];
                    // Convert to JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    if (jsonData.length < 2) {
                        throw new Error('?? ????? ????? ??? ?????? ?????');
                    }
                    // Extract headers
                    const headers = jsonData[0];
                    const pmarkIndex = headers.indexOf('Pmark');
                    const profileIndex = headers.indexOf('Profile');
                    const lengthIndex = headers.indexOf('Length');
                    const pweightIndex = headers.indexOf('Pweight');
                    const qtyIndex = headers.indexOf('Qty');
                    const tweightIndex = headers.indexOf('Tweight');
                    
                    if (pmarkIndex === -1 || profileIndex === -1 || lengthIndex === -1 || 
                        pweightIndex === -1 || qtyIndex === -1 || tweightIndex === -1) {
                        throw new Error('??? ?? ????? ????? ??? ??????? ????????');
                    }
                    
                    // Process data rows
                    excelData = [];
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row.length > 0) {
                            const pmark = row[pmarkIndex] !== undefined && row[pmarkIndex] !== null ? row[pmarkIndex] : '';
                            const profile = row[profileIndex] !== undefined && row[profileIndex] !== null ? row[profileIndex] : '';
                            const length = row[lengthIndex] !== undefined && row[lengthIndex] !== null ? row[lengthIndex] : 0;
                            const pweight = row[pweightIndex] !== undefined && row[pweightIndex] !== null ? row[pweightIndex] : 0;
                            const qty = row[qtyIndex] !== undefined && row[qtyIndex] !== null ? row[qtyIndex] : 0;
                            const tweight = row[tweightIndex] !== undefined && row[tweightIndex] !== null ? row[tweightIndex] : 0;
                            
                            // Check if all required fields are present (not just truthy)
                            if (pmark !== '' && profile !== '' && 
                                (length !== null && length !== undefined) && 
                                (pweight !== null && pweight !== undefined) && 
                                (qty !== null && qty !== undefined) && 
                                (tweight !== null && tweight !== undefined)) {
                                
                                excelData.push({
                                    pmark,
                                    profile,
                                    length: Number(length),
                                    pweight: Number(pweight),
                                    qty: Number(qty),
                                    tweight: Number(tweight)
                                });
                            }
                        }
                    }
                    // Update file info
                    fileName.textContent = file.name;
                    fileDetails.textContent = `${excelData.length} ??????`;
                    fileInfo.classList.remove('hidden');
                    calculateExcelBtn.disabled = false;
                    // Update progress bar
                    progressFill.style.width = '100%';
                } catch (error) {
                    alert(`??? ?? ?????? ?????: ${error.message}`);
                    resetExcelSection();
                }
            };
            reader.onprogress = function(e) {
                if (e.lengthComputable) {
                    const percent = (e.loaded / e.total) * 100;
                    progressFill.style.width = `${percent}%`;
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function calculateForExcel() {
            if (excelData.length === 0) return;
            
            let totalSteel = 0;
            let totalSurface = 0;
            let totalZinc = 0;
            let totalQty = 0;
            
            // Clear table body
            excelTableBody.innerHTML = '';
            
            // Process each item
            excelData.forEach(item => {
                const profileData = parseProfile(item.profile);
                const length = Number(item.length);
                const qty = Number(item.qty);
                const pweight = Number(item.pweight);
                const tweight = Number(item.tweight);
                
                // Check if length and qty are valid numbers
                if (!isNaN(length) && !isNaN(qty) && length >= 0 && qty > 0) {
                    // Calculate surface area
                    const surfaceArea = profileData ? calculateSurfaceArea(profileData, length) : 0;
                    
                    // Determine thickness for zinc coating
                    let thickness = 0;
                    if (profileData) {
                        switch (profileData.type) {
                            case 'plate':
                                thickness = profileData.thickness;
                                break;
                            case 'angle':
                                thickness = profileData.thickness;
                                break;
                            case 'iBeam':
                                const iBeamData = I_BEAM_DATA[`IPE ${profileData.size}`];
                                thickness = iBeamData ? iBeamData.thickness_mm : 0;
                                break;
                            case 'uChannel':
                                const uChannelData = U_CHANNEL_DATA[`UPN ${profileData.size}`];
                                thickness = uChannelData ? uChannelData.thickness_mm : 0;
                                break;
                            case 'pipe':
                                thickness = profileData.thickness;
                                break;
                            default:
                                thickness = 0;
                        }
                    }
                    
                    // Get zinc coating info
                    const zincInfo = getZincCoatingInfo(thickness);
                    
                    // Calculate zinc weight per piece (in grams)
                    const zincPerPiece = (surfaceArea / 1000000) * zincInfo.weight_g_m2;
                    
                    // Calculate total zinc for this item
                    const totalZincForItem = zincPerPiece * qty;
                    
                    // Update totals
                    totalSteel += tweight;
                    totalSurface += (surfaceArea / 1000000) * qty;
                    totalZinc += totalZincForItem;
                    totalQty += qty;
                    
                    // Add row to table
                    const row = document.createElement('tr');
                    row.className = 'table-row';
                    row.innerHTML = `
                        <td class="py-3 px-4 text-right">${item.pmark}</td>
                        <td class="py-3 px-4 text-right">${item.profile}</td>
                        <td class="py-3 px-4 text-right">${length.toLocaleString()}</td>
                        <td class="py-3 px-4 text-right">${qty.toLocaleString()}</td>
                        <td class="py-3 px-4 text-right">${pweight.toFixed(2)}</td>
                        <td class="py-3 px-4 text-right">${(surfaceArea / 1000000).toFixed(4)}</td>
                        <td class="py-3 px-4 text-right">${totalZincForItem.toFixed(2)}</td>
                    `;
                    excelTableBody.appendChild(row);
                }
            });
            
            // Update summary
            totalSteelWeight.textContent = `${totalSteel.toFixed(2)} ???`;
            totalSurfaceArea.textContent = `${totalSurface.toFixed(4)} ?²`;
            totalZincWeight.textContent = `${totalZinc.toFixed(2)} ??`;
            totalItems.textContent = totalQty.toLocaleString();
            
            // Show results
            excelResults.classList.remove('hidden');
        }
        
        function exportResults() {
            if (excelData.length === 0) return;
            
            // Create a new workbook
            const wb = XLSX.utils.book_new();
            
            // Prepare data for export
            const exportData = excelData.map(item => {
                const profileData = parseProfile(item.profile);
                const length = Number(item.length);
                const qty = Number(item.qty);
                let surfaceArea = 0;
                let zincPerPiece = 0;
                let totalZinc = 0;
                
                if (profileData) {
                    surfaceArea = calculateSurfaceArea(profileData, length);
                    
                    // Determine thickness for zinc coating
                    let thickness = 0;
                    if (profileData) {
                        switch (profileData.type) {
                            case 'plate':
                                thickness = profileData.thickness;
                                break;
                            case 'angle':
                                thickness = profileData.thickness;
                                break;
                            case 'iBeam':
                                const iBeamData = I_BEAM_DATA[`IPE ${profileData.size}`];
                                thickness = iBeamData ? iBeamData.thickness_mm : 0;
                                break;
                            case 'uChannel':
                                const uChannelData = U_CHANNEL_DATA[`UPN ${profileData.size}`];
                                thickness = uChannelData ? uChannelData.thickness_mm : 0;
                                break;
                            case 'pipe':
                                thickness = profileData.thickness;
                                break;
                            default:
                                thickness = 0;
                        }
                    }
                    
                    // Get zinc coating info
                    const zincInfo = getZincCoatingInfo(thickness);
                    
                    // Calculate zinc weight per piece (in grams)
                    zincPerPiece = (surfaceArea / 1000000) * zincInfo.weight_g_m2;
                    
                    // Calculate total zinc for this item
                    totalZinc = zincPerPiece * qty;
                }
                
                return {
                    '??????': item.pmark,
                    '?????': item.profile,
                    '????? (??)': item.length,
                    '??????': item.qty,
                    '????? ?????? (???)': item.pweight.toFixed(2),
                    '????? ???????? (???)': item.tweight.toFixed(2),
                    '??????? ?????? (?²)': (surfaceArea / 1000000).toFixed(4),
                    '??????? ????????? (?²)': ((surfaceArea / 1000000) * qty).toFixed(4),
                    '????? ?????? (??)': zincPerPiece.toFixed(2),
                    '????? ???????? (??)': totalZinc.toFixed(2)
                };
            });
            
            // Add summary row
            exportData.push({});
            exportData.push({
                '??????': '????????',
                '??????': totalItems.textContent,
                '????? ???????? (???)': totalSteelWeight.textContent.replace(' ???', ''),
                '??????? ????????? (?²)': totalSurfaceArea.textContent.replace(' ?²', ''),
                '????? ???????? (??)': totalZincWeight.textContent.replace(' ??', '')
            });
            
            // Create worksheet
            const ws = XLSX.utils.json_to_sheet(exportData);
            
            // Add workbook properties
            const today = new Date();
            const dateStr = `${today.getFullYear()}-${today.getMonth()+1}-${today.getDate()}`;
            
            // Add to workbook
            XLSX.utils.book_append_sheet(wb, ws, '????? ???????');
            
            // Export
            XLSX.writeFile(wb, `?????_?????_${dateStr}.xlsx`);
        }
        
        function resetExcelSection() {
            excelData = [];
            fileInfo.classList.add('hidden');
            excelResults.classList.add('hidden');
            calculateExcelBtn.disabled = true;
            progressFill.style.width = '0%';
            excelFileInput.value = '';
        }
        // --- EVENT LISTENERS ---
        sectionTypeSelect.addEventListener('change', updateVisibleInputs);
        calculateBtn.addEventListener('click', performCalculations);
        document.getElementById('lang-ar').addEventListener('click', () => switchLanguage('ar'));
        document.getElementById('lang-en').addEventListener('click', () => switchLanguage('en'));
        // Excel file handling events
        selectFileBtn.addEventListener('click', () => excelFileInput.click());
        excelFileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                processExcelFile(e.target.files[0]);
            }
        });
        // Drag and drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => {
                dropArea.classList.add('active', 'pulse');
            }, false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => {
                dropArea.classList.remove('active', 'pulse');
            }, false);
        });
        dropArea.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processExcelFile(files[0]);
            }
        });
        clearFileBtn.addEventListener('click', resetExcelSection);
        calculateExcelBtn.addEventListener('click', calculateForExcel);
        exportResultsBtn.addEventListener('click', exportResults);
        // --- INITIALIZATION ---
        switchLanguage('ar'); // Default to Arabic
        updateVisibleInputs();
        populateAngleSelector();
        populateIBeamSelector();
        populateUChannelSelector();
    </script>
</body>
</html>